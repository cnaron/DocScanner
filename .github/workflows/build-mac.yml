name: Build macOS App

on:
  workflow_dispatch:
  # å¦‚éœ€è‡ªåŠ¨è§¦å‘ï¼ŒæŒ‰éœ€è§£å¼€æ³¨é‡Šï¼š
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'app/**'
  #     - 'inference.py'
  #     - 'requirements.txt'
  #     - '.github/workflows/build-mac.yml'

jobs:
  build-mac:
    strategy:
      matrix:
        include:
          - runner: macos-14   # Apple Silicon (arm64)
            arch: arm64
          - runner: macos-13   # Intel (x86_64)
            arch: x86_64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å¯é€‰ï¼špip ç¼“å­˜ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # ğŸ”§ é¢„è£…è¿™äº›ä»¥é¿å… macos-13 (x86_64) ä¸Šçš„ numpy æºç ç¼–è¯‘/mingw32 è¯¯åˆ¤é—®é¢˜
          pip install "numpy<2" scipy cython
          # é¡¹ç›®ä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # PyTorchï¼ˆmacOS ä¼šè£… Metal/CPU ç‰ˆï¼Œé€‚é… arm64/x86_64ï¼‰
          pip install torch torchvision torchaudio
          # æ‰“åŒ…ä¸æ¨¡å‹ä¸‹è½½
          pip install pyinstaller gdown

      - name: Download pretrained model (DocScanner-L)
        run: |
          mkdir -p model_pretrained
          if [ -z "$(ls -A model_pretrained 2>/dev/null)" ]; then
            gdown --fuzzy --folder "https://drive.google.com/drive/folders/1W1_DJU8dfEh6FqDYqFQ7ypR38Z8c5r4D" -O model_pretrained
          fi
          ls -lah model_pretrained

      - name: Verify model exists
        run: |
          if [ ! -d "model_pretrained" ] || [ -z "$(ls -A model_pretrained)" ]; then
            echo "æ¨¡å‹ä¸‹è½½å¤±è´¥ï¼šmodel_pretrained ä¸ºç©º"
            exit 1
          fi

      - name: Prepare runtime dirs
        run: |
          mkdir -p distorted rectified app

      - name: Build .app with PyInstaller
        # macOS ä¸‹ --add-data ä½¿ç”¨ å†’å· åˆ†éš” src:dst
        run: |
          pyinstaller --noconfirm --windowed \
            --name "DocScanner" \
            --add-data "model_pretrained:model_pretrained" \
            --add-data "inference.py:." \
            --add-data "distorted:distorted" \
            --add-data "rectified:rectified" \
            --add-data "app:app" \
            --hidden-import torch \
            app/main.py
          # äº§ç‰©ï¼šdist/DocScanner.app

      - name: Zip app
        run: |
          cd dist
          ditto -c -k --sequesterRsrc --keepParent "DocScanner.app" "../DocScanner-mac-${{ matrix.arch }}.zip"
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DocScanner-mac-${{ matrix.arch }}
          path: DocScanner-mac-${{ matrix.arch }}.zip
