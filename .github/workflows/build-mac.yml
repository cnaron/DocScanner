name: Build macOS App

on:
  workflow_dispatch:
  # 如需自动触发，按需解开注释：
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'app/**'
  #     - 'inference.py'
  #     - 'requirements.txt'
  #     - '.github/workflows/build-mac.yml'

jobs:
  build-mac:
    strategy:
      matrix:
        include:
          - runner: macos-14   # Apple Silicon (arm64)
            arch: arm64
          - runner: macos-13   # Intel (x86_64)
            arch: x86_64
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 可选：pip 缓存，加速依赖安装
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          # 🔧 预装这些以避免 macos-13 (x86_64) 上的 numpy 源码编译/mingw32 误判问题
          pip install "numpy<2" scipy cython
          # 项目依赖
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # PyTorch（macOS 会装 Metal/CPU 版，适配 arm64/x86_64）
          pip install torch torchvision torchaudio
          # 打包与模型下载
          pip install pyinstaller gdown

      - name: Download pretrained model (DocScanner-L)
        run: |
          mkdir -p model_pretrained
          if [ -z "$(ls -A model_pretrained 2>/dev/null)" ]; then
            gdown --fuzzy --folder "https://drive.google.com/drive/folders/1W1_DJU8dfEh6FqDYqFQ7ypR38Z8c5r4D" -O model_pretrained
          fi
          ls -lah model_pretrained

      - name: Verify model exists
        run: |
          if [ ! -d "model_pretrained" ] || [ -z "$(ls -A model_pretrained)" ]; then
            echo "模型下载失败：model_pretrained 为空"
            exit 1
          fi

      - name: Prepare runtime dirs
        run: |
          mkdir -p distorted rectified app

      - name: Build .app with PyInstaller
        # macOS 下 --add-data 使用 冒号 分隔 src:dst
        run: |
          pyinstaller --noconfirm --windowed \
            --name "DocScanner" \
            --add-data "model_pretrained:model_pretrained" \
            --add-data "inference.py:." \
            --add-data "distorted:distorted" \
            --add-data "rectified:rectified" \
            --add-data "app:app" \
            --hidden-import torch \
            app/main.py
          # 产物：dist/DocScanner.app

      - name: Zip app
        run: |
          cd dist
          ditto -c -k --sequesterRsrc --keepParent "DocScanner.app" "../DocScanner-mac-${{ matrix.arch }}.zip"
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DocScanner-mac-${{ matrix.arch }}
          path: DocScanner-mac-${{ matrix.arch }}.zip
